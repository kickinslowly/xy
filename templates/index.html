{% extends "base.html" %}
{% block title %}Interactive Coordinate Plane{% endblock %}
{% block body_class %}mode-plane{% endblock %}
{% block extra_head %}
  <link rel="stylesheet" href="{{ url_for('static', filename='style.css') }}" />
{% endblock %}

{% block content %}
  <header class="app-header full-bleed" role="banner">
    <nav class="toolbar panels" aria-label="Canvas controls">
      <details class="panel">
        <summary>Session</summary>
        <div class="group" role="group" aria-label="Session">
          <span id="presence" title="Number of users currently online in this document">‚Ä¢ Offline</span>
          <button id="shareSessionBtn" class="btn btn-secondary" type="button" title="Show and copy PIN to share">Share</button>
          <button id="joinSessionBtn" class="btn btn-secondary" type="button" title="Join another session by PIN">Join another session</button>
        </div>
      </details>
      <details class="panel">
        <summary>View</summary>
        <div class="group" role="group" aria-label="View controls">
          <button id="zoomOut" type="button" title="Zoom out (-)" aria-label="Zoom out">‚àí</button>
          <button id="zoomIn" type="button" title="Zoom in (+)" aria-label="Zoom in">+</button>
          <label for="ppu">
            Pixels per unit:
          </label>
          <input id="ppu" type="number" min="5" max="400" step="1" value="50" aria-label="Pixels per unit" />
          <label for="gridStep">Grid step (units):</label>
          <select id="gridStep" aria-label="Grid step">
            <option value="0.5">0.5</option>
            <option value="1" selected>1</option>
            <option value="2">2</option>
            <option value="5">5</option>
            <option value="10">10</option>
          </select>
        </div>
      </details>

      <details class="panel">
        <summary><svg class="summary-icon" viewBox="0 0 24 24" aria-hidden="true" focusable="false"><circle cx="12" cy="12" r="5" fill="currentColor"/></svg>Vertices</summary>
        <div class="group" role="group" aria-label="Vertex settings">
          <label for="vertexColor">Vertex color:</label>
          <input id="vertexColor" type="color" value="#d81b60" aria-label="Vertex color" />
          <label for="vertexSize">Vertex size:</label>
          <input id="vertexSize" type="number" min="2" max="20" step="1" value="6" aria-label="Vertex size" />
          <button id="clearVertices" type="button">Clear vertices</button>
        </div>
      </details>

      <details class="panel">
        <summary><svg class="summary-icon" viewBox="0 0 24 24" aria-hidden="true" focusable="false"><line x1="5" y1="19" x2="19" y2="5" stroke="currentColor" stroke-width="2" stroke-linecap="round"/></svg>Lines</summary>
        <div class="group" role="group" aria-label="Line settings">
          <label for="lineColor">Line color:</label>
          <input id="lineColor" type="color" value="#1e88e5" aria-label="Line color" />
          <label for="lineWidth">Line thickness:</label>
          <input id="lineWidth" type="number" min="1" max="20" step="1" value="2" aria-label="Line thickness" />
          <button id="connectSelected" type="button">Connect selected</button>
          <label for="closeLoop" style="display:inline-flex; gap:.5rem; align-items:center;">
            <input id="closeLoop" type="checkbox" />
            Close loop
          </label>
          <button id="clearLines" type="button">Clear lines</button>
        </div>
      </details>

      <details class="panel">
        <summary><svg class="summary-icon" viewBox="0 0 24 24" aria-hidden="true" focusable="false"><rect x="4" y="5" width="16" height="14" rx="2" ry="2" stroke="currentColor" fill="none" stroke-width="2"/><circle cx="10" cy="11" r="2" fill="currentColor"/><path d="M6 17l4-4 3 3 5-5 2 2" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/></svg>Images</summary>
        <div class="group" role="group" aria-label="Image tools">
          <button id="addImageBtn" type="button" title="Add an image to the plane">Add image</button>
          <button id="clearImages" type="button" title="Remove all images">Clear images</button>
        </div>
      </details>

      <details class="panel">
        <summary>Transformations</summary>
        <div class="group" role="group" aria-label="Transforms">
          <button id="reflectBtn" type="button" title="Reflect selected vertices across a line">Reflect</button>
          <button id="rotateBtn" type="button" title="Rotate selected vertices around a point">Rotate</button>
          <button id="scaleBtn" type="button" title="Scale selected vertices from a point">Scale</button>
          <button id="translateBtn" type="button" title="Translate selected vertices by a vector">Translate</button>
        </div>
        <div id="reflectExtras" class="group transform-extras" style="display:none;" role="group" aria-label="Reflect settings">
          <span id="modeHint" class="hint" style="display:none;">Click two points to define a reflection line. Press Esc to cancel.</span>
        </div>
        <div id="rotateExtras" class="group transform-extras" style="display:none;" role="group" aria-label="Rotate settings">
          <label for="rotateAngle">Angle (deg):</label>
          <input id="rotateAngle" type="number" step="0.1" value="0" aria-label="Rotation angle in degrees" />
          <label for="rotateDir">Direction:</label>
          <select id="rotateDir" aria-label="Rotation direction">
            <option value="ccw" selected>CCW (+)</option>
            <option value="cw">CW (‚àí)</option>
          </select>
          <span id="rotateHint" class="hint" style="display:none;">Click to choose rotation center, then drag to rotate. Or type an angle and press Enter. Esc to cancel.</span>
        </div>
        <div id="scaleExtras" class="group transform-extras" style="display:none;" role="group" aria-label="Scale settings">
          <label for="scaleFactor">Factor:</label>
          <input id="scaleFactor" type="number" step="0.1" value="1" aria-label="Scale factor" />
          <span id="scaleHint" class="hint" style="display:none;">Click to choose scale center, then drag to scale. Or type a factor and press Enter. Esc to cancel.</span>
        </div>
        <div id="translateExtras" class="group transform-extras" style="display:none;" role="group" aria-label="Translate settings">
          <label for="translateDx">dx:</label>
          <input id="translateDx" type="number" step="0.1" value="0" aria-label="Translate dx" />
          <label for="translateDy">dy:</label>
          <input id="translateDy" type="number" step="0.1" value="0" aria-label="Translate dy" />
          <button id="translateApply" type="button" title="Apply numeric translation">Apply</button>
          <span id="translateHint" class="hint" style="display:none;">Click and drag to set translation vector, or type dx, dy and press Apply. Esc to cancel.</span>
        </div>
      </details>

    </nav>
  </header>

  <main class="main-wrap full-bleed" role="main">
    <aside class="sidebar sidebar-left" aria-label="Quick actions">
      <div class="sidebar-header">
        <h3>Actions</h3>
        <small>Undo/redo, clear, export</small>
      </div>
      <div class="action-buttons" style="padding: 8px 12px;">
        <button id="undoBtn" class="btn-outline" type="button" title="Undo (Ctrl+Z)" style="width:100%;">‚Ü∂ Undo</button>
        <button id="redoBtn" class="btn-outline" type="button" title="Redo (Ctrl+Y or Ctrl+Shift+Z)" style="width:100%;">‚Ü∑ Redo</button>
        <button id="deleteSelected" class="btn-neutral" type="button" title="Delete selected vertices/lines/images" style="width:100%;">üóëÔ∏è Delete selected</button>
        <button id="clearSelection" class="btn-neutral" type="button" title="Clear selection" style="width:100%;">‚ú® Clear selection</button>
        <button id="clearAll" class="btn-danger btn-sm" type="button" title="Remove all content" style="width:100%;">Delete all</button>
        <button id="exportPdfBtn" class="btn-neutral" type="button" title="Export current view as PDF" style="width:100%;">üìÑ Export PDF</button>
      </div>
    </aside>
    <div class="canvas-wrap">
      <canvas id="plane" width="1000" height="650" aria-label="Interactive coordinate plane" role="img"></canvas>
    </div>
    <aside class="sidebar" aria-label="Vertex readout">
      <div class="sidebar-header">
        <h3>Vertices</h3>
        <small>Click canvas to add. Edit labels here.</small>
      </div>
      <div style="padding: 8px 12px;">
        <button id="createInfiniteLine" type="button" title="Graph an infinite line based on selected vertices" style="width:100%;">Graph this Line</button>
      </div>
      <div id="mathInfo" class="series-card" style="margin: 8px 12px;">
        <div><strong>Line info</strong> <small class="hint">Select any 2 vertices</small></div>
        <div id="mathInfoContent" class="hint">Select two vertices to see slope and equation.</div>
      </div>
      <ul id="vertexList" class="vertex-list" aria-live="polite"></ul>
    </aside>
  </main>

  <!-- Image gallery modal -->
  <div id="imageModal" class="modal" hidden aria-hidden="true" role="dialog" aria-label="Choose an image">
    <div class="modal-backdrop" data-close="1"></div>
    <div class="modal-content">
      <div class="modal-header">
        <h3>Choose an image</h3>
        <button id="closeImageModal" type="button" aria-label="Close">√ó</button>
      </div>
      <div class="gallery">
        {% if available_images %}
          {% for img in available_images %}
            <button class="gallery-item" type="button" title="{{ img }}" data-filename="{{ img }}">
              <img src="{{ url_for('static', filename=img) }}" alt="{{ img }}" />
            </button>
          {% endfor %}
        {% else %}
          <p class="hint" style="padding:8px 12px;">No images found in the static folder.</p>
        {% endif %}
      </div>
    </div>
  </div>

  <!-- Share QR modal -->
  <div id="qrModal" class="modal" hidden aria-hidden="true" role="dialog" aria-label="Share session">
    <div class="modal-backdrop" data-close="1"></div>
    <div class="modal-content">
      <div class="modal-header">
        <h3>Share session</h3>
        <button id="closeQrModal" type="button" aria-label="Close">√ó</button>
      </div>
      <div style="padding:16px; display:flex; gap:16px; align-items:center; flex-wrap:wrap; justify-content:center;">
        <img id="qrImage" alt="QR code to join session" style="width:256px; height:256px; image-rendering: pixelated; border:1px solid rgba(0,0,0,0.1); border-radius:8px; background:#fff;" />
        <div style="min-width:260px; max-width:520px;">
          <p id="qrPinText" class="hint" style="margin:0 0 8px; font-weight:700;">PIN: ‚Äî</p>
          <p class="hint" style="margin:0 0 8px;">Scan to join this session, or share the link below:</p>
          <input id="qrLinkText" type="text" readonly style="width:100%;" />
        </div>
      </div>
    </div>
  </div>
{% endblock %}

{% block extra_scripts %}
  <script src="https://cdn.jsdelivr.net/npm/jspdf@2.5.1/dist/jspdf.umd.min.js"></script>
  <script src="https://cdn.socket.io/4.7.5/socket.io.min.js" crossorigin="anonymous"></script>
  <script src="{{ url_for('static', filename='main.js') }}"></script>
{% endblock %}
